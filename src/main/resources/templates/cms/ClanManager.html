<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" CONTENT="no-cache">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <link rel="stylesheet" type="text/css" href="/static/css/common.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/loader.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/button.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/townhall.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/warLeague.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/cms/manager.css" />

  <script src="/static/js/common.js"></script>
  <script src="/static/js/util.js"></script>
  <script src="/static/js/api/league.js"></script>
  <script src="/static/js/api/clan.js"></script>
  <script src="/static/js/api/player.js"></script>

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

  <!-- JavaScript Year and Month Picker -->
  <script src="https://jsuites.net/v4/jsuites.js"></script>
  <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" integrity="sha512-FwNWaxyfy2XlEINoSnZh1JQ5TRRtGow0D6XcmAWmYCRgvqOUTnzCxPc9uF35u5ZEpirk1uhlPVA19tflhvnW1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
  dayjs.locale('ko')
  </script>

  <title>클랜 관리</title>


  <script>
    function switchFilterNotJoined(type) {
      const btnCloses = document.querySelectorAll('.btn-close');
      btnCloses.forEach(ele => ele.click());

      if (type === 'clan') {
        const btnViewClanAssignedPlayers = document.querySelectorAll('.btn-view-clan-assigned-player');
        btnViewClanAssignedPlayers.forEach(viewAssignedPlayerAndFilterNotJoined);
        return;
      }

      if (type === 'league') {
        const btnViewLeagueAssignedPlayers = document.querySelectorAll('.btn-view-league-assigned-player');
        btnViewLeagueAssignedPlayers.forEach(viewLeagueAssignedPlayerAndFilterNotJoined);
        return;
      }
    }

    async function viewAssignedPlayerAndFilterNotJoined(element) {
      const card = element.closest('.card');
      const clanContent = JSON.parse(card.dataset.clanContent);

      // 클랜전 컨텐츠 이용 클랜이 아닌 경우
      if (clanContent.clanWarYn !== 'Y') return;

      await viewAssignedPlayer(element);
      const btnFilterNotJoined = card.querySelector('.card-assigned-player-wrapper .btn-filter-not-joined');
      btnFilterNotJoined.click();
    }

    async function viewLeagueAssignedPlayerAndFilterNotJoined(element) {
      const card = element.closest('.card');
      const clanContent = JSON.parse(card.dataset.clanContent);

      // 리그전 컨텐츠 이용 클랜이 아닌 경우
      if (clanContent.clanWarLeagueYn !== 'Y') return;

      await viewLeagueAssignedPlayer(element);
      const btnFilterNotJoined = card.querySelector('.card-league-assigned-player-wrapper .btn-filter-not-joined');
      btnFilterNotJoined.click();
    }

    function displayUploadForm(element, type) {
      const assignedPlayerUpload = document.querySelector(`.${type}.assigned-player-upload`);
      if (assignedPlayerUpload.classList.contains('display-none')) {
        assignedPlayerUpload.classList.remove('display-none');
        element.classList.add('expand');
      } else {
        assignedPlayerUpload.classList.add('display-none');
        element.classList.remove('expand');
      }
    }

    function changeFile(element) {
      const assignedPlayerUpload = element.closest('.assigned-player-upload');
      const assignedPlayerUploadForm = assignedPlayerUpload.querySelector('.assigned-player-upload-form');
      const label = assignedPlayerUploadForm.querySelector('.label');

      const { files } = element;
      if (!files.length) {
        label.innerHTML = 'Click to upload excel';
        return;
      }

      const [file] = files;
      label.innerHTML = file.name;
    }
    function readExcelFile(element) {
      const assignedPlayerUpload = element.closest('.assigned-player-upload');
      const isAssignedLeague = assignedPlayerUpload.classList.contains('league');
      const inputMonthElement = assignedPlayerUpload.querySelector('.input-month');
      if (!inputMonthElement.value) {
        alert('배정 월을 선택해주세요.');
        return;
      }
      const fileInput = assignedPlayerUpload.querySelector('.assigned-player-excel');
      const { files } = fileInput;
      if (!files.length) {
        alert('배정 엑셀 파일을 선택해주세요');
        return;
      }

      const [file] = files;
      const seasonDate = inputMonthElement.value.replace(/\D/g, "");
      const reader = new FileReader();
      reader.onload = function () {
        let data = reader.result;
        let workBook = XLSX.read(data, { type: 'binary' });
        let [firstSheetName] = workBook.SheetNames
        let readAssignedPlayers = XLSX.utils.sheet_to_json(workBook.Sheets[firstSheetName]);

        const clanAssignedPlayers = convertObject(readAssignedPlayers);
        const isInvalid = validateClanAssignedPlayers(clanAssignedPlayers);
        if (isInvalid) return;

        if (isAssignedLeague) {
          // 리그 배정
          registerClanLeagueAssignedPlayers(seasonDate, clanAssignedPlayers);
          return;
        }

        // 클랜 배정
        registerClanAssignedPlayers(seasonDate, clanAssignedPlayers);
      };

      reader.readAsBinaryString(file);
    }

    function convertObject(players) {
        return players.map(makeObject);
        function makeObject(player) {
          return {
            player_tag: player['클랜원태그'],
            clan_tag: player['배정클랜태그']
          }
        }
    }

    function validateClanAssignedPlayers(players) {
      for (let i=0; i<players.length; i++) {
        const { player_tag, clan_tag } = players[i];
        if (!player_tag) {
          alert(`${i+2}행 클랜원태그 입력 필요`);
          return true;
        }

        if (!clan_tag) {
          alert(`${i+2}행 배정클랜태그 입력 필요`);
          return true;
        }
      }

      const findDuplicates = arr => arr.filter((item, index) => arr.indexOf(item) !== index);
      const duplicates = findDuplicates(players.map(player => player.player_tag))
      if (duplicates.length) {
        alert(`클랜원태그 중복이 확인되었습니다.\n${duplicates}`);
        return;
      }
      return false;
    }

    function clearSearchResult() {
      const searchResultElement = document.querySelector('.search-result');

      const searchedClanCard = searchResultElement.querySelector('.card');
      if (searchedClanCard) {
        searchResultElement.removeChild(searchedClanCard);
      }
    }

    async function addClan(element) {
      const cardElement = element.closest('.card');
      const { dataset } = cardElement;
      const { clanTag, clanName, badgeUrls } = dataset;

      if (!confirm(`${clanName}(${clanTag})를 등록하시겠습니까?\n`)) {
        return;
      }

      const requestBody = {
        tag: clanTag,
        name: clanName,
        badge_url: JSON.parse(badgeUrls)
      }

      const registeredClan = await registerClan(requestBody)
      if (!registeredClan) {
        return;
      }

      const [clanDetail] = await fetchClansFromExternal([registeredClan]);
      clanDetail.order = registeredClan.order;
      clanDetail.clanContent = registeredClan.clanContent;
      const clansListElement = document.querySelector('.clan-list');
      renderClan(clanDetail, clansListElement);

      clearSearchResult();
    }

    function clearFooter(searchResultElement) {
      const cardFooters = searchResultElement.querySelectorAll('.card-footer');
      for (const cardFooter of cardFooters) {
        cardFooter.remove();
      }
    }

    function replaceRemoveToAddButton(searchResultElement) {
      const btnRemove = searchResultElement.querySelector('.btn-remove');

      const clanCardRegisterButtonTemplate = document.querySelector("#clan-card-register-button");
      const clanCardRegisterButton = document.importNode(clanCardRegisterButtonTemplate.content, true);
      const btnAddElement = clanCardRegisterButton.querySelector('.btn-add');

      btnRemove.replaceWith(btnAddElement);
    }

    function searchClan() {
        const searchInput = document.querySelector('#search-input');
        if (!searchInput.value) {
          alert('클랜 태그를 입력해주세요.');
          return;
        }

        fetchClan(searchInput.value)
        .then((clan) => {
          clearSearchResult();

          const searchResultElement = document.querySelector('.search-result');
          renderClan(clan, searchResultElement);
          clearFooter(searchResultElement);
          replaceRemoveToAddButton(searchResultElement);
        })
        .catch((error) => {
          clearSearchResult();

          const clanCardNotFoundTemplate = document.querySelector("#clan-card-not-found");
          const clanCard = document.importNode(clanCardNotFoundTemplate.content, true);
          const emptyCard = clanCard.querySelector('.card');

          const searchResultElement = document.querySelector('.search-result');
          searchResultElement.appendChild(emptyCard);
        })
    }

  function removeClan(element) {
      const cardElement = element.closest('.card');
      const { dataset } = cardElement;
      const { clanTag, clanName } = dataset;

      if (!confirm(`[클랜] ${clanName}(${clanTag})를 삭제하시겠습니까?\n`)) {
        return;
      }

      deleteClan(clanTag)
        .then((response) => {
          cardElement.remove();
        })
    }

    function convYn(yn) {
      if (yn === 'Y') return "비노출"
      return "노출"
    }

    async function changeContentYn(element) {
      const cardElement = element.closest('.card');
      const { clanTag } = cardElement.dataset;
      const { dataset } = element;
      const { btnName, yn, menuName } = dataset;

      if (!confirm(`${btnName} 메뉴에서 ${convYn(yn)}하시겠습니까?`)) {
        return;
      }

      const changeYn = yn === 'Y' ? 'N' : 'Y';
      const requestBody = {}
      requestBody.tag = clanTag;
      requestBody[menuName] = changeYn;

      const result = await updateClanContent(requestBody);
      if (result) {
        // 성공 처리
        element.dataset.yn = changeYn;
        settingDisabled(element);
      }
    }

    let leagueMap = {}
    async function loadLeagues() {
      // 리그 목록 조회
      const leagues = await fetchLeagues();
      leagues.map(league => {
        leagueMap[league.name] = league;
      });
    }

    function makeClanMapByTag(clans) {
      return clans.reduce((map, clan) => {
        map[clan.tag] = clan
        return map
      }, {});
    }

    function renderClanBadge(badgeUrls, card) {
      if (!badgeUrls) return;

      const { small } = badgeUrls;
      if (small) {
        const clanBadge = card.querySelector('.clan-badge');
        clanBadge.src = small;
      }
    }

    function renderWarLeagueBadge(warLeague, card) {
      if (!warLeague) return;

      const { name } = warLeague;
      let warLeagueIconClassName = name.replace(/\s/g, "");

      const warLeagueElement = card.querySelector('.clan-war-league-badge');

      if (warLeagueIconClassName !== 'Unranked') {
        warLeagueElement.classList.add(warLeagueIconClassName);
      } else {
        const leagueLabel = leagueMap[name];
        if (leagueLabel) {
          const {iconUrls} = leagueLabel;
          const {small} = iconUrls;
          const imgElement = document.createElement('img');
          imgElement.src = small;
          imgElement.classList.add('clan-war-league-badge', 'icon');
          warLeagueElement.replaceWith(imgElement);
        }
      }

      card.innerHTML = card.innerHTML.replace(/{CLAN_WAR_LABEL}/, convLeagueName(name));
    }

    function renderCapitalLeagueBadge(capitalLeague, card) {
      if (!capitalLeague) return;

      const { name } = capitalLeague;
      const leagueLabel = leagueMap[name];
      if (leagueLabel) {
        const { iconUrls } = leagueLabel;
        const { small } = iconUrls;
        const leagueBadge = card.querySelector('.capital-league-badge');
        leagueBadge.src = small;
      }

      card.innerHTML = card.innerHTML.replace(/{CLAN_CAPITAL_LABEL}/, convLeagueName(name))
    }

    function findLeader(memberList) {
      return memberList.filter(member => member.role === 'leader');
    }

    function settingDataYn(btnElement, yn) {
      btnElement.dataset.yn = yn;
      settingDisabled(btnElement);
    }

    function settingDisabled(btnElement) {
      const { yn } = btnElement.dataset;
      if (yn === 'N') {
        btnElement.classList.add('disabled');
      } else {
        btnElement.classList.remove('disabled');
      }
    }

    function renderClanContent(clanContent, card) {
      if (!clanContent) return;

      const { tag, clanWarYn, clanWarLeagueYn, clanCapitalYn, clanWarParallelYn } = clanContent;

      const btnClanWar = card.querySelector('.btn-clan-war');
      settingDataYn(btnClanWar, clanWarYn);
      const btnClanWarLeague = card.querySelector('.btn-clan-war-league');
      settingDataYn(btnClanWarLeague, clanWarLeagueYn);
      const btnClanCapital = card.querySelector('.btn-clan-capital');
      settingDataYn(btnClanCapital, clanCapitalYn);

      const btnClanWarParallel = card.querySelector('.btn-clan-war-parallel');
      settingDataYn(btnClanWarParallel, clanWarParallelYn);
    }

    function renderLabel(label, card) {
      const clanLabelTemplate = document.querySelector("#clan-label-template");
      const clanLabel = document.importNode(clanLabelTemplate.content, true);
      const labelIcon = clanLabel.querySelector('.label-icon');

      const { iconUrls } = label;
      const { small } = iconUrls;

      labelIcon.src = small;

      const targetElement = card.querySelector('.text-body');
      targetElement.appendChild(clanLabel);
    }

    function renderLabels(labels, card) {
      labels.forEach((label) => renderLabel(label, card))
    }

    function renderClan(clan, targetElement) {
      const clanCardTemplate = document.querySelector("#clan-card");
      const clanCard = document.importNode(clanCardTemplate.content, true);
      const card = clanCard.querySelector('.card');

      const { name, tag, type, badgeUrls, warLeague, capitalLeague, memberList, members, clanPoints, clanCapitalPoints, labels, clanContent } = clan;
      const [leader] = findLeader(memberList);

      // dataset
      card.dataset.clanTag = tag;
      card.dataset.clanName = name;
      card.dataset.badgeUrls = JSON.stringify(badgeUrls);
      card.dataset.clanContent = JSON.stringify(clanContent);

      card.innerHTML = card.innerHTML
                           .replace(/{CLAN_NAME}/, name)
                           .replace(/{CLAN_TAG}/g, tag)
                           .replace(/{CLAN_TYPE}/, convClanJoinTypeName(type))
                           .replace(/{CLAN_LEADER}/, leader.name)
                           .replace(/{CLAN_TROPHIES}/, Number(clanPoints).toLocaleString())
                           .replace(/{CLAN_MEMBERS}/, members)
                           .replace(/{CLAN_CAPITAL_POINTS}/, Number(clanCapitalPoints).toLocaleString());

      renderClanBadge(badgeUrls, card);
      renderWarLeagueBadge(warLeague, card);
      renderCapitalLeagueBadge(capitalLeague, card);

      renderClanContent(clanContent, card);

      renderLabels(labels, card);

      settingTooltips(card);

      targetElement.appendChild(card);
    }

    function settingTooltips(element) {
      const clanTagChip = element.querySelector('.clan-tag');
      settingTooltip(clanTagChip, '클랜 태그');

      const clanTypeChip = element.querySelector('.clan-type');
      settingTooltip(clanTypeChip, '가입 유형');

      const clanLeaderChip = element.querySelector('.clan-leader');
      settingTooltip(clanLeaderChip, '대표 계정');

      const clanMemberChip = element.querySelector('.clan-members');
      settingTooltip(clanMemberChip, '클랜 인원');

      const iconTrophiesChip = element.querySelector('.clan-trophies');
      settingTooltip(iconTrophiesChip, '클랜 트로피');

      const clanWarLeagueChip = element.querySelector('.clan-war-league');
      settingTooltip(clanWarLeagueChip, '클랜 리그전');

      const clanCapitalChip = element.querySelector('.clan-capital');
      settingTooltip(clanCapitalChip, '습격전 리그');

      const clanCapitalPointsChip = element.querySelector('.clan-capital-points');
      settingTooltip(clanCapitalPointsChip, '습격전 포인트');
    }

    function renderClans(clans) {
      const clansListElement = document.querySelector('.clan-list');
      clans.forEach((clan) => renderClan(clan, clansListElement))
    }

    async function getClans() {
      showWifiLoading('.clan-manager');
      let clans = await fetchClans();
      let clanDetailMap = makeClanMapByTag(await fetchClansFromExternal(clans));

      let resultClans = [];
      clans.forEach(clan => {
        // 객체 병합
        const clanDetail = clanDetailMap[clan.tag];
        clanDetail.order = clan.order;
        clanDetail.clanContent = clan.clanContent;
        resultClans.push(clanDetail);
      });

      renderClans(resultClans)

      hideWifiLoading('.clan-manager');
    }

    function closeCurrentPlayer(element) {
      const cardElement = element.closest('div.card');

      const cardBasic = cardElement.querySelector('.card-basic');
      cardBasic.classList.remove('display-none');

      const cardCurrentPlayerWrapper = cardElement.querySelector('.card-current-player-wrapper');
      cardCurrentPlayerWrapper.classList.add('display-none');

      const loaderElement = cardCurrentPlayerWrapper.querySelector('.loader-circle');
      loaderElement.classList.remove('display-none');

      // 필터 초기화
      cardCurrentPlayerWrapper.querySelector('.btn-filter-all').click();
    }

    function closeAssignedPlayer(element) {
      const cardElement = element.closest('div.card');

      const cardBasic = cardElement.querySelector('.card-basic');
      cardBasic.classList.remove('display-none');

      const cardAssignedPlayerWrapper = cardElement.querySelector('.card-assigned-player-wrapper');
      cardAssignedPlayerWrapper.classList.add('display-none');

      const loaderElement = cardAssignedPlayerWrapper.querySelector('.loader-circle');
      loaderElement.classList.remove('display-none');

      // 필터 초기화
      cardAssignedPlayerWrapper.querySelector('.btn-filter-all').click();
    }

    function closeLeagueAssignedPlayer(element) {
      const cardElement = element.closest('div.card');

      const cardBasic = cardElement.querySelector('.card-basic');
      cardBasic.classList.remove('display-none');

      const cardAssignedPlayerWrapper = cardElement.querySelector('.card-league-assigned-player-wrapper');
      cardAssignedPlayerWrapper.classList.add('display-none');

      const loaderElement = cardAssignedPlayerWrapper.querySelector('.loader-circle');
      loaderElement.classList.remove('display-none');

      // 필터 초기화
      cardAssignedPlayerWrapper.querySelector('.btn-filter-all').click();
    }

    function isWarPreferenceIn(warPreference) {
      return warPreference === 'in';
    }

    function convWarPreferenceName(warPreference) {
      return isWarPreferenceIn(warPreference) ? '참가' : '불참';
    }

    function makeLabelChip(tag) {
      const playerInfoAdditionalTemplate = document.querySelector('#player-info-additional-template');
      const playerInfoAdditional = document.importNode(playerInfoAdditionalTemplate.content, true);
      const chip = playerInfoAdditional.querySelector('.chip');
      chip.innerHTML = chip.innerHTML.replace(/{NAME}/, tag);
      return chip;
    }

    function renderAdditionalLabel(infoAdditionalElement, tag) {
      const chip = makeLabelChip(tag);
      infoAdditionalElement.appendChild(chip);
      return chip;
    }

    function renderAssignedPlayer(clanAssignedPlayers, clanMembersMap, cardElement) {

      const { clanTag, seasonDate, players } = clanAssignedPlayers;

      const playerInfoTemplate = document.querySelector('#clan-player-info-template');

      const cardAssignedPlayer = cardElement.querySelector('.card-assigned-player');
      const playerList = cardAssignedPlayer.querySelector('.player-list');
      playerList.innerHTML = ""; // clear

      const sortedPlayers = sortByHeroTotalLevel(players);
      let joinedSize = 0;
      let warPreferenceSize = 0;
      for (const player of sortedPlayers) {
        const playerInfoElement = document.importNode(playerInfoTemplate.content, true);
        const playerInfo = playerInfoElement.querySelector('.player-info');

        const { townHallLevel, name, tag, heroTotalLevel, warPreference, clan } = player;

        const joinedClan = clanMembersMap[player.tag];
        const joinedStatusName = joinedClan ? '이동 완료' : '이동 필요';

        // dataset
        playerInfo.dataset.assignedType = 'clan';
        playerInfo.dataset.clanTag = clanTag;
        playerInfo.dataset.seasonDate = seasonDate;
        playerInfo.dataset.name = name;
        playerInfo.dataset.playerTag = tag;
        playerInfo.dataset.joinedStatus = !!joinedClan;
        playerInfo.dataset.warPreference = isWarPreferenceIn(warPreference);

        // render
        playerInfo.innerHTML = playerInfo.innerHTML
                                         .replace(/{TOWNHALL_LEVEL}/, townHallLevel)
                                         .replace(/{NAME}/, name)
                                         .replace(/{HERO_TOTAL_LEVEL}/, heroTotalLevel)
                                         .replace(/{CURRENT_CLAN}/, clan ? clan.name : '클랜 없음')
                                         .replace(/{JOINED}/, joinedStatusName);

        const infoAdditionalElement = playerInfo.querySelector('.info.additional');
        renderAdditionalLabel(infoAdditionalElement, tag);
        const warPreferenceLabel = renderAdditionalLabel(infoAdditionalElement, convWarPreferenceName(warPreference));
        const bgColor = isWarPreferenceIn(warPreference) ? 'bg-green' : 'bg-crimson';
        warPreferenceLabel.classList.add(bgColor);

        if (!joinedClan) {
          playerInfo.classList.add('not-joined');
        } else {
          joinedSize++;

          if (isWarPreferenceIn(warPreference)) {
            warPreferenceSize++;
          }
        }

        playerList.appendChild(playerInfoElement);
      }

      cardAssignedPlayer.querySelector('.total-size').innerHTML = players.length;
      cardAssignedPlayer.querySelector('.joined-size').innerHTML = joinedSize;
      cardAssignedPlayer.querySelector('.war-preference-size').innerHTML = warPreferenceSize;
    }

    async function viewCurrentClanPlayers(element) {

      const cardElement = element.closest('div.card');
      const { clanTag } = cardElement.dataset;

      // 기본 카드 숨김
      const cardBasic = cardElement.querySelector('.card-basic');
      cardBasic.classList.add('display-none');

      // 로딩바 노출
      const cardCurrentPlayerWrapper = cardElement.querySelector('.card-current-player-wrapper');
      cardCurrentPlayerWrapper.classList.remove('display-none');

      const clanMembers = await fetchClanMembers([{tag: clanTag}]);

      //전체 클랜원 태그 조회
      const allPlayerTags = await fetchAllPlayerTags();
      const allPlayerTagSet =  new Set(allPlayerTags);

      //지원계정 목록 조회
      const supportPlayers = await fetchSupportPlayers();
      const supportPlayerMap = convertArrayToMapByKey(supportPlayers);

      renderCurrentPlayer(clanMembers, allPlayerTagSet, supportPlayerMap, cardElement);

      // 로딩바 숨김
      const loaderElement = cardCurrentPlayerWrapper.querySelector('.loader-circle');
      loaderElement.classList.add('display-none');

      // 현재클랜원 노출
      const cardAssignedPlayer = cardElement.querySelector('.card-current-player .body');
      cardAssignedPlayer.classList.remove('display-none');

    }

    function convertJoinedLabel(isClanPlayer, isSupportPlayer) {
      if (!isClanPlayer) return '미등록계정'
      if (isSupportPlayer) return '지원계정'
      return '';
    }

    function renderCurrentPlayer(currentClanMembers, allPlayerTagSet, supportPlayerMap, cardElement) {

      const playerInfoTemplate = document.querySelector('#clan-player-info-template');

      const cardCurrentPlayer = cardElement.querySelector('.card-current-player');
      const playerList = cardCurrentPlayer.querySelector('.player-list');
      playerList.innerHTML = ""; // clear

      const sortedPlayers = sortByTrophies(currentClanMembers);

      let unknownPlayers = 0;
      let supportPlayers = 0;
      for (const player of sortedPlayers) {
        const playerInfoElement = document.importNode(playerInfoTemplate.content, true);
        const playerInfo = playerInfoElement.querySelector('.player-info');

        const { townHallLevel, name, tag, trophies, role, clanRank, previousClanRank } = player;

        const isClanPlayer = allPlayerTagSet.has(tag);
        const isSupportPlayer = !!supportPlayerMap.get(tag);
        const changeRank = previousClanRank - clanRank;

        // render
        playerInfo.innerHTML = playerInfo.innerHTML
                                         .replace(/{TOWNHALL_LEVEL}/, townHallLevel)
                                         .replace(/{NAME}/, name)
                                         .replace(/{HERO_TOTAL_LEVEL}/, trophies)
                                         .replace(/{CURRENT_CLAN}/, "")
                                         .replace(/{JOINED}/, convertJoinedLabel(isClanPlayer, isSupportPlayer));

        const infoAdditionalElement = playerInfo.querySelector('.info.additional');
        renderAdditionalLabel(infoAdditionalElement, tag);
        renderAdditionalLabel(infoAdditionalElement, convRoleName(role));

        //랭킹 변화 라벨 추가
        if (previousClanRank !== 0) {
          const displayLank = changeRank === 0 ? '=' : Math.abs(changeRank)
          const changeRankLabel = makeLabelChip(displayLank);
          changeRankLabel.classList.add('label-change-rank');
          if (changeRank === 0) {
            changeRankLabel.classList.add('bg-lightgray');
          } else if (changeRank > 0) {
            changeRankLabel.classList.add('bg-green');

            const iconArrowUpTemplate = document.querySelector('#icon-arrow-up');
            const iconArrowUp = document.importNode(iconArrowUpTemplate.content, true);
            changeRankLabel.prepend(iconArrowUp);
          } else {
            const iconArrowDownTemplate = document.querySelector('#icon-arrow-down');
            const iconArrowDown = document.importNode(iconArrowDownTemplate.content, true);
            changeRankLabel.classList.add('bg-crimson');
            changeRankLabel.prepend(iconArrowDown);
          }

          const tagHeroLevel = playerInfo.querySelector('.tag-hero-level');
          tagHeroLevel.insertAdjacentElement("afterEnd", changeRankLabel);
        }

        // 현재 클랜원 표기 설정
        // 배정 삭제 버튼 제거
        playerInfo.querySelector('.btn-remove-member').remove();
        const tagHeroLevel = playerInfo.querySelector('.tag-hero-level');
        tagHeroLevel.classList.remove('bg-crimson');
        tagHeroLevel.classList.add('bg-gold');

        const iconTrophiesTemplate = document.querySelector('#icon-trophies');
        const iconTrophies = document.importNode(iconTrophiesTemplate.content, true);
        tagHeroLevel.prepend(iconTrophies);

        if (!isClanPlayer) {
          unknownPlayers++;
          playerInfo.classList.add('unknown-player');
        } else {
          if (isSupportPlayer) {
            supportPlayers++;
            playerInfo.classList.add('support-player');
          }
        }

        playerList.appendChild(playerInfoElement);
      }

      cardCurrentPlayer.querySelector('.total-size').innerHTML = currentClanMembers.length;
      cardCurrentPlayer.querySelector('.unknown-size').innerHTML = unknownPlayers;
      cardCurrentPlayer.querySelector('.support-size').innerHTML = supportPlayers;
    }

    async function viewAssignedPlayer(element) {

      const cardElement = element.closest('div.card');
      const { clanTag } = cardElement.dataset;

      // 기본 카드 숨김
      const cardBasic = cardElement.querySelector('.card-basic');
      cardBasic.classList.add('display-none');

      // 로딩바 노출
      const cardAssignedPlayerWrapper = cardElement.querySelector('.card-assigned-player-wrapper');
      cardAssignedPlayerWrapper.classList.remove('display-none');

      // 배정 클랜원 목록
      const clanAssignedPlayers = await fetchClanAssignedMembers(clanTag);

      const clanMembers = await fetchClanMembers([{tag: clanTag}]);
      const clanMembersMap = makeMapByTag(clanMembers);

      const seasonDate = cardAssignedPlayerWrapper.querySelector('.season-date');
      seasonDate.innerHTML = formatYYMMDate(clanAssignedPlayers.seasonDate);

      // dataset
      cardElement.dataset.seasonDate = clanAssignedPlayers.seasonDate;

      renderAssignedPlayer(clanAssignedPlayers, clanMembersMap, cardElement);

      // 로딩바 숨김
      const loaderElement = cardAssignedPlayerWrapper.querySelector('.loader-circle');
      loaderElement.classList.add('display-none');

      // 배정클랜원 노출
      const cardAssignedPlayer = cardElement.querySelector('.card-assigned-player .body');
      cardAssignedPlayer.classList.remove('display-none');

    }

    function filterSupportPlayer(element, type) {
      changeDisplay(element, `${type}-player`);
    }

    function changeDisplay(element, className) {
      const assignedCard = element.closest('.player-card');
      const playerListElement = assignedCard.querySelector('.player-list');

      for (const playerInfo of playerListElement.children) {
        if (className.startsWith('all')) {
          playerInfo.classList.remove('display-none');
          continue;
        }

        playerInfo.classList.add('display-none');
        if (playerInfo.classList.contains(className)) {
          playerInfo.classList.remove('display-none');
        }

      }
    }

    function filterNotJoined(element, type) {
      changeDisplay(element, type);
    }

    async function assignedMember(element) {
      const playerInfoElement = element.closest('.player-info');
      const { dataset } = playerInfoElement;
      const { assignedType, clanTag, seasonDate, playerTag, name } = dataset;

      if (assignedType === 'clan') {
        assignedClanPlayer(clanTag, seasonDate, playerTag)
        .then((response) => {
          // 화면 갱신
          setTimeout(() => viewAssignedPlayer(element), 100);
        })
        return;
      }

      if (assignedType === 'league') {
        assignedLeaguePlayer(clanTag, seasonDate, playerTag)
        .then((response) => {
          // 화면 갱신
          setTimeout(() => viewLeagueAssignedPlayer(element), 100);
        })
        return;
      }
    }

    function removeClanAssignedPlayer(dataset, playerInfoElement) {

      const { clanTag, seasonDate, playerTag, joinedStatus, warPreference } = dataset;
      const result = deleteAssignedMember(clanTag, seasonDate, playerTag);
      if (result) {
        const cardElement = playerInfoElement.closest('div.card');
        const totalSize = cardElement.querySelector('.total-size');
        totalSize.innerHTML = Number(totalSize.innerHTML) - 1; // 배정인원 갱신
        if (JSON.parse(joinedStatus)) {
          const joinedSize = cardElement.querySelector('.joined-size');
          joinedSize.innerHTML = Number(joinedSize.innerHTML) - 1; // 이동인원 갱신
        }
        if (warPreference) {
          const warPreferenceSize = cardElement.querySelector('.war-preference-size');
          warPreferenceSize.innerHTML = Number(warPreferenceSize.innerHTML) - 1; // 선호인원 갱신
        }
        playerInfoElement.remove();
      }

    }

    function removeLeagueAssignedPlayer(dataset, playerInfoElement) {

      const { clanTag, seasonDate, playerTag, joinedStatus } = dataset;
      const result = deleteClanLeagueAssignedMember(clanTag, seasonDate, playerTag);
      if (result) {
        const cardLeagueAssignedPlayer = playerInfoElement.closest('.card-league-assigned-player');
        const totalSize = cardLeagueAssignedPlayer.querySelector('.total-size');
        totalSize.innerHTML = Number(totalSize.innerHTML) - 1; // 배정인원 갱신
        if (JSON.parse(joinedStatus)) {
          const joinedSize = cardLeagueAssignedPlayer.querySelector('.joined-size');
          joinedSize.innerHTML = Number(joinedSize.innerHTML) - 1; // 이동인원 갱신
        }
        playerInfoElement.remove();
      }

    }

    async function removeAssignedMember(element) {
      const playerInfoElement = element.closest('.player-info');
      const { dataset } = playerInfoElement;
      const { assignedType, name, playerTag } = dataset;

      const displayName = assignedType === 'clan' ? '클랜' : '리그'
      if (!confirm(`${name} (${playerTag}) 계정을 ${displayName} 배정에서 삭제하시겠습니까?`)) {
        return;
      }

      if (assignedType === 'clan') {
        // 클랜 배정 삭제
        return removeClanAssignedPlayer(dataset, playerInfoElement);
      }

      if (assignedType === 'league') {
        // 리그 배정 삭제
        return removeLeagueAssignedPlayer(dataset, playerInfoElement);
      }
    }

    function appendButtonAssigned(playerInfoElement) {
      const buttonAssigned = document.querySelector('#button-player-assigned');
      const buttonAssignedElement = document.importNode(buttonAssigned.content, true);
      const playerInfoItem = buttonAssignedElement.querySelector('.player-info-item');

      const layoutRight = playerInfoElement.querySelector('.layout-right');
      layoutRight.innerHTML = ""; // clear
      layoutRight.appendChild(playerInfoItem);
    }

    function searchPlayer(element) {
      const assignedPlayerForm = element.closest('.assigned-player-form');
      const searchInput = assignedPlayerForm.querySelector('.player-search-input');
      if (!searchInput.value) {
        alert('플레이어 태그를 입력해주세요.');
        return;
      }

      const isAssignedLeague = assignedPlayerForm.classList.contains('assigned-league');

      const clanCardElement = element.closest('div.card');
      const { clanTag, seasonDate } = clanCardElement.dataset;

      const searchResultElement = assignedPlayerForm.querySelector('.player-search-result');
      searchResultElement.innerHTML = ""; //clear

      findPlayer(searchInput.value)
      .then(player => {
        const playerInfoTemplate = document.querySelector('#clan-player-info-template');
        const playerInfoElement = document.importNode(playerInfoTemplate.content, true);
        const playerInfo = playerInfoElement.querySelector('.player-info');

        const { townHallLevel, name, tag, heroTotalLevel, warPreference, clan } = player;

        // dataset
        playerInfo.dataset.assignedType = isAssignedLeague ? 'league' : 'clan';
        playerInfo.dataset.clanTag = clanTag;
        playerInfo.dataset.seasonDate = seasonDate;
        playerInfo.dataset.name = name;
        playerInfo.dataset.playerTag = tag;

        // render
        playerInfo.innerHTML = playerInfo.innerHTML
                                         .replace(/{TOWNHALL_LEVEL}/, townHallLevel)
                                         .replace(/{NAME}/, name)
                                         .replace(/{TAG}/, tag)
                                         .replace(/{HERO_TOTAL_LEVEL}/, heroTotalLevel)
                                         .replace(/{CURRENT_CLAN}/, clan ? clan.name : '클랜 없음');

        const infoAdditionalElement = playerInfo.querySelector('.info.additional');
        renderAdditionalLabel(infoAdditionalElement, tag);
        const warPreferenceLabel = renderAdditionalLabel(infoAdditionalElement, convWarPreferenceName(warPreference));
        const bgColor = isWarPreferenceIn(warPreference) ? 'bg-green' : 'bg-crimson';
        warPreferenceLabel.classList.add(bgColor);

        // clear
        playerInfo.querySelector('.btn-remove-member').remove();

        appendButtonAssigned(playerInfo);

        searchResultElement.appendChild(playerInfoElement);
      })
      .catch(error => {
          const playerNotFoundTemplate = document.querySelector("#player-not-found");
          const playerCard = document.importNode(playerNotFoundTemplate.content, true);
          const emptyCard = playerCard.querySelector('.card');

          searchResultElement.appendChild(emptyCard);
      })
    }

    async function viewLeagueAssignedPlayer(element) {

      const cardElement = element.closest('div.card');
      const { clanTag } = cardElement.dataset;

      // 기본 카드 숨김
      const cardBasic = cardElement.querySelector('.card-basic');
      cardBasic.classList.add('display-none');

      // 로딩바 노출
      const cardLeagueAssignedPlayerWrapper = cardElement.querySelector('.card-league-assigned-player-wrapper');
      cardLeagueAssignedPlayerWrapper.classList.remove('display-none');

      const clanAssignedPlayers = await fetchClanLeagueAssignedMembers(clanTag);

      const clanMembers = await fetchClanMembers([{tag: clanTag}]);
      const clanMembersMap = makeMapByTag(clanMembers);

      const seasonDate = cardLeagueAssignedPlayerWrapper.querySelector('.season-date');
      seasonDate.innerHTML = formatYYMMDate(clanAssignedPlayers.seasonDate);

      // dataset
      cardElement.dataset.seasonDate = clanAssignedPlayers.seasonDate;

      renderLeagueAssignedPlayer(clanAssignedPlayers, clanMembersMap, cardElement);

      // 로딩바 숨김
      const loaderElement = cardLeagueAssignedPlayerWrapper.querySelector('.loader-circle');
      loaderElement.classList.add('display-none');

      // 배정클랜원 노출
      const cardLeagueAssignedPlayer = cardElement.querySelector('.card-league-assigned-player .body');
      cardLeagueAssignedPlayer.classList.remove('display-none');

    }

    function renderLeagueAssignedPlayer(clanAssignedPlayers, clanMembersMap, cardElement) {

      const { clanTag, seasonDate, players } = clanAssignedPlayers;

      const playerInfoTemplate = document.querySelector('#clan-player-info-template');

      const cardLeagueAssignedPlayer = cardElement.querySelector('.card-league-assigned-player');
      const playerList =  cardLeagueAssignedPlayer.querySelector('.player-list');
      playerList.innerHTML = ""; // clear

      const sortedPlayers = sortByHeroTotalLevel(players);
      let joinedSize = 0;
      for (const player of sortedPlayers) {
        const playerInfoElement = document.importNode(playerInfoTemplate.content, true);
        const playerInfo = playerInfoElement.querySelector('.player-info');

        const { townHallLevel, name, tag, heroTotalLevel, warPreference, clan } = player;

        const joinedClan = clanMembersMap[player.tag];
        const joinedStatusName = joinedClan ? '이동 완료' : '이동 필요';

        // dataset
        playerInfo.dataset.assignedType = 'league';
        playerInfo.dataset.clanTag = clanTag;
        playerInfo.dataset.seasonDate = seasonDate;
        playerInfo.dataset.name = name;
        playerInfo.dataset.playerTag = tag;
        playerInfo.dataset.joinedStatus = !!joinedClan;

        // render
        playerInfo.innerHTML = playerInfo.innerHTML
                                         .replace(/{TOWNHALL_LEVEL}/, townHallLevel)
                                         .replace(/{NAME}/, name)
                                         .replace(/{HERO_TOTAL_LEVEL}/, heroTotalLevel)
                                         .replace(/{CURRENT_CLAN}/, clan ? clan.name : '클랜 없음')
                                         .replace(/{JOINED}/, joinedStatusName);

        const infoAdditionalElement = playerInfo.querySelector('.info.additional');
        renderAdditionalLabel(infoAdditionalElement, tag);

        if (!joinedClan) {
          playerInfo.classList.add('not-joined');
        } else {
          joinedSize++;
        }

        playerList.appendChild(playerInfoElement);
      }

      cardLeagueAssignedPlayer.querySelector('.total-size').innerHTML = players.length;
      cardLeagueAssignedPlayer.querySelector('.joined-size').innerHTML = joinedSize;
    }

    function initMonthPicker() {
      const firstDayOfMonth = dayjs().date(1).format('YYYY-MM-DD');
      const monthPickers = document.querySelectorAll('input.input-month');
      const options = {
        type: 'year-month-picker',
        format: 'YYYY-MM',
        validRange: [ firstDayOfMonth ],
        controls: false,
        readonly: true,
        value: firstDayOfMonth, // default
        months: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
        monthsFull: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월']
      }
      for (const monthPicker of monthPickers) {
        jSuites.calendar(monthPicker, options);
      }
    }

    window.onload = async () => {
      initMonthPicker();
      await loadLeagues();
      await getClans();
    }
  </script>

</head>
<body>
<div class="clan-manager">
  <div id="wifi-loader" class="display-none">
    <svg class="circle-outer" viewBox="0 0 86 86">
      <circle class="back" cx="43" cy="43" r="40"></circle>
      <circle class="front" cx="43" cy="43" r="40"></circle>
      <circle class="new" cx="43" cy="43" r="40"></circle>
    </svg>
    <svg class="circle-middle" viewBox="0 0 60 60">
      <circle class="back" cx="30" cy="30" r="27"></circle>
      <circle class="front" cx="30" cy="30" r="27"></circle>
    </svg>
    <svg class="circle-inner" viewBox="0 0 34 34">
      <circle class="back" cx="17" cy="17" r="14"></circle>
      <circle class="front" cx="17" cy="17" r="14"></circle>
    </svg>
    <div class="text" data-text="Searching"></div>
  </div>

  <div class="form-register-clan">

    <div class="search w270">
      <div class="search-box">
        <div class="search-field">
          <input placeholder="등록하실 클랜 태그를 입력해주세요" class="input" type="text" id="search-input">
          <div class="search-box-icon">
            <button class="btn-icon-content" onclick="searchClan(); return false;">
              <i class="search-icon">
                <svg class="icon-search" aria-hidden="true" viewBox="0 0 24 24"><g><path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path></g></svg>
              </i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="search-result"></div>
  </div>

  <div class="form-button-area">
    <div class="button-chip bg-green" onclick="displayUploadForm(this, 'clan'); return false;">
      <span>배정클랜 일괄등록</span>
      <i class="fa-solid fa-caret-up"></i>
    </div>
    <div class="button-chip bg-crimson" onclick="displayUploadForm(this, 'league'); return false;">
      <span>리그배정 일괄등록</span>
      <i class="fa-solid fa-caret-up"></i>
    </div>
  </div>
  <div class="form-upload-area">
    <div class="clan assigned-player-upload display-none">
      <div class="assigned-player-upload-form">
        <table class="table vertical">
          <caption class="table-caption">
          <span class="description">
            클랜 배정월의 배정된 정보는 초기화되며,<br>엑셀 파일로 일괄 재배정됩니다.
          </span>
          </caption>
          <tbody class="table-tbody">
          <tr class="table-tr">
            <th class="table-th">배정월</th>
            <td class="table-td">
              <div class="picker">
                <input type="text" class="input-month">
              </div>
            </td>
          </tr>
          <tr class="table-tr">
            <th class="table-th">
              파일
            </th>
            <td class="table-td">
              <label class="file-upload-form" for="assigned-player-excel">
                <div class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="" viewBox="0 0 24 24"><g stroke-width="0" id="SVGRepo_bgCarrier"></g><g stroke-linejoin="round" stroke-linecap="round" id="SVGRepo_tracerCarrier"></g><g id="SVGRepo_iconCarrier"> <path fill="" d="M10 1C9.73478 1 9.48043 1.10536 9.29289 1.29289L3.29289 7.29289C3.10536 7.48043 3 7.73478 3 8V20C3 21.6569 4.34315 23 6 23H7C7.55228 23 8 22.5523 8 22C8 21.4477 7.55228 21 7 21H6C5.44772 21 5 20.5523 5 20V9H10C10.5523 9 11 8.55228 11 8V3H18C18.5523 3 19 3.44772 19 4V9C19 9.55228 19.4477 10 20 10C20.5523 10 21 9.55228 21 9V4C21 2.34315 19.6569 1 18 1H10ZM9 7H6.41421L9 4.41421V7ZM14 15.5C14 14.1193 15.1193 13 16.5 13C17.8807 13 19 14.1193 19 15.5V16V17H20C21.1046 17 22 17.8954 22 19C22 20.1046 21.1046 21 20 21H13C11.8954 21 11 20.1046 11 19C11 17.8954 11.8954 17 13 17H14V16V15.5ZM16.5 11C14.142 11 12.2076 12.8136 12.0156 15.122C10.2825 15.5606 9 17.1305 9 19C9 21.2091 10.7909 23 13 23H20C22.2091 23 24 21.2091 24 19C24 17.1305 22.7175 15.5606 20.9844 15.122C20.7924 12.8136 18.858 11 16.5 11Z" clip-rule="evenodd" fill-rule="evenodd"></path> </g></svg>
                </div>
                <div class="text">
                  <span class="label">Click to upload excel</span>
                </div>
                <input type="file" id="assigned-player-excel" class="assigned-player-excel" accept=".xlsx" onchange="changeFile(this); return false;">
              </label>
            </td>
          </tr>
          <tr class="table-tr">
            <td colspan="2" class="table-td">
              <div class="button-wrapper">
                <div class="button-chip bg-green" onclick="readExcelFile(this); return false;">클랜 배정</div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="league assigned-player-upload display-none">
      <div class="assigned-player-upload-form">
        <table class="table vertical league">
          <caption class="table-caption league">
          <span class="description">
            리그 배정월의 배정된 정보는 초기화되며,<br>엑셀 파일로 일괄 재배정됩니다.
          </span>
          </caption>
          <tbody class="table-tbody">
          <tr class="table-tr">
            <th class="table-th">배정월</th>
            <td class="table-td">
              <div class="picker">
                <input type="text" class="input-month">
              </div>
            </td>
          </tr>
          <tr class="table-tr">
            <th class="table-th">
              파일
            </th>
            <td class="table-td">
              <label class="file-upload-form" for="league-assigned-player-excel">
                <div class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="" viewBox="0 0 24 24"><g stroke-width="0" id="SVGRepo_bgCarrier"></g><g stroke-linejoin="round" stroke-linecap="round" id="SVGRepo_tracerCarrier"></g><g id="SVGRepo_iconCarrier"> <path fill="" d="M10 1C9.73478 1 9.48043 1.10536 9.29289 1.29289L3.29289 7.29289C3.10536 7.48043 3 7.73478 3 8V20C3 21.6569 4.34315 23 6 23H7C7.55228 23 8 22.5523 8 22C8 21.4477 7.55228 21 7 21H6C5.44772 21 5 20.5523 5 20V9H10C10.5523 9 11 8.55228 11 8V3H18C18.5523 3 19 3.44772 19 4V9C19 9.55228 19.4477 10 20 10C20.5523 10 21 9.55228 21 9V4C21 2.34315 19.6569 1 18 1H10ZM9 7H6.41421L9 4.41421V7ZM14 15.5C14 14.1193 15.1193 13 16.5 13C17.8807 13 19 14.1193 19 15.5V16V17H20C21.1046 17 22 17.8954 22 19C22 20.1046 21.1046 21 20 21H13C11.8954 21 11 20.1046 11 19C11 17.8954 11.8954 17 13 17H14V16V15.5ZM16.5 11C14.142 11 12.2076 12.8136 12.0156 15.122C10.2825 15.5606 9 17.1305 9 19C9 21.2091 10.7909 23 13 23H20C22.2091 23 24 21.2091 24 19C24 17.1305 22.7175 15.5606 20.9844 15.122C20.7924 12.8136 18.858 11 16.5 11Z" clip-rule="evenodd" fill-rule="evenodd"></path> </g></svg>
                </div>
                <div class="text">
                  <span class="label">Click to upload excel</span>
                </div>
                <input type="file" id="league-assigned-player-excel" class="assigned-player-excel" accept=".xlsx" onchange="changeFile(this); return false;">
              </label>
            </td>
          </tr>
          <tr class="table-tr">
            <td colspan="2" class="table-td">
              <div class="button-wrapper">
                <div class="button-chip bg-crimson" onclick="readExcelFile(this); return false;">리그 배정</div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="support-filter">
    <div class="radio-inputs filter">
      <label class="radio">
        <input type="radio" name="all-filter-not-joined" onclick="switchFilterNotJoined('close');" checked>
        <span class="name">이동 확인 닫기</span>
      </label>
      <label class="radio">
        <input type="radio" name="all-filter-not-joined" onclick="switchFilterNotJoined('clan');">
        <span class="name">클랜 이동 확인</span>
      </label>

      <label class="radio">
        <input type="radio" name="all-filter-not-joined" onclick="switchFilterNotJoined('league');">
        <span class="name">리그 이동 확인</span>
      </label>
    </div>
  </div>

  <div class="clan-list"></div>
</div>
</body>
<template id="clan-card">
  <div class="card">
    <div class="card-button color-red btn-remove" onclick="removeClan(this); return false;">
      <i class="fa-regular fa-rectangle-xmark"></i>
    </div>

    <div class="text-title">
      <img class="clan-badge icon">
      <span class="title">{CLAN_NAME}</span>
    </div>

    <div class="card-basic">

      <div class="card-info">

        <div class="text-body">
          <div class="chip clan-tag">{CLAN_TAG}</div>
          <div class="chip bg-orange clan-type">{CLAN_TYPE}</div>
          <div class="chip bg-blue clan-leader">{CLAN_LEADER}</div>
          <div class="chip bg-green clan-members">
            <i class="fa-solid fa-user color-white"></i>
            <span class="chip-label">{CLAN_MEMBERS}</span>
          </div>
          <div class="chip bg-gold clan-trophies">
            <div class="icon trophies"></div>
            <span class="chip-label">{CLAN_TROPHIES}</span>
          </div>
          <div class="chip bg-pink clan-capital-points">
            <div class="icon icon-clan-capital"></div>
            <span class="chip-label">{CLAN_CAPITAL_POINTS}</span>
          </div>
          <div class="chip bg-crimson clan-war-league">
            <div class="clan-war-league-badge img-icon icon"></div>
            <span class="chip-label">{CLAN_WAR_LABEL}</span>
          </div>
          <div class="chip bg-forestgreen clan-capital">
            <img class="capital-league-badge icon">
            <span class="chip-label">{CLAN_CAPITAL_LABEL}</span>
          </div>
        </div>
      </div>

      <div class="card-footer">
        <div class="card-button btn-clan-war" data-btn-name="클랜전 현황" data-menu-name="clan_war_yn" onclick="changeContentYn(this); return false;">
          <i class="icon-clan-war"></i>
          <span class="chip">클랜전</span>
        </div>
        <div class="card-button btn-clan-war-league" data-btn-name="리그전 현황" data-menu-name="clan_war_league_yn" onclick="changeContentYn(this); return false;">
          <i class="icon-clan-war-league"></i>
          <span class="chip">리그전</span>
        </div>
        <div class="card-button btn-clan-capital" data-btn-name="습격전 현황" data-menu-name="clan_capital_yn" onclick="changeContentYn(this); return false;">
          <i class="icon-clan-capital"></i>
          <span class="chip">습격전</span>
        </div>
        <div class="card-button btn-clan-war-parallel" data-btn-name="병행클랜전 현황" data-menu-name="clan_war_parallel_yn" onclick="changeContentYn(this); return false;" style="filter: hue-rotate(45deg);">
          <i class="icon-clan-war"></i>
          <span class="chip">병행클랜전</span>
        </div>
      </div>

      <div class="card-footer support">
        <div class="card-button" onclick="viewCurrentClanPlayers(this);">
          <span class="button-chip bg-black">현재 클랜원</span>
        </div>
        <div class="card-button btn-view-clan-assigned-player" onclick="viewAssignedPlayer(this);">
          <span class="button-chip bg-green">클랜 배정</span>
        </div>
        <div class="card-button btn-view-league-assigned-player" onclick="viewLeagueAssignedPlayer(this);">
          <span class="button-chip bg-crimson">리그 배정</span>
        </div>
      </div>

    </div>

    <div class="player-wrapper card-current-player-wrapper display-none">
      <div class="loader-circle">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
        <div class="bar4"></div>
        <div class="bar5"></div>
        <div class="bar6"></div>
        <div class="bar7"></div>
        <div class="bar8"></div>
        <div class="bar9"></div>
        <div class="bar10"></div>
        <div class="bar11"></div>
        <div class="bar12"></div>
      </div>

      <div class="player-card card-current-player">
        <div class="caption">
          <div class="layout-left">현재 클랜원</div>
          <div class="layout-right">
            <div class="button-chip btn-close" onclick="closeCurrentPlayer(this);">닫기</div>
          </div>
        </div>

        <div class="manager-button-area">
          <!--            <div class="button-chip bg-orange">일괄 배정</div>-->
          <!--            <div class="button-chip bg-crimson">일괄 삭제</div>-->
        </div>

        <div class="body display-none">

          <div class="support-area">
            <div class="info">
              <span class="regular-text">가입 인원 : <span class="total-size"></span> 명</span>
              <span class="regular-text">미등록 계정 : <span class="unknown-size"></span> 명</span>
              <span class="regular-text">지원 계정 : <span class="support-size"></span> 명</span>
            </div>
            <div class="button-area player-filter-wrapper">
              <div class="radio-inputs player-filter">
                <label class="radio">
                  <input type="radio" name="player-filter-{CLAN_TAG}" onclick="filterSupportPlayer(this, 'all');" class="btn-filter-all" checked>
                  <span class="name">전체</span>
                </label>
                <label class="radio">
                  <input type="radio" name="player-filter-{CLAN_TAG}" onclick="filterSupportPlayer(this, 'unknown');">
                  <span class="name">미등록계정</span>
                </label>

                <label class="radio">
                  <input type="radio" name="player-filter-{CLAN_TAG}" onclick="filterSupportPlayer(this, 'support');" class="btn-filter-not-joined">
                  <span class="name">지원계정</span>
                </label>
              </div>
            </div>
          </div>

          <div class="player-list"></div>

        </div>
      </div>
    </div>

    <div class="card-assigned-player-wrapper display-none">
      <div class="loader-circle">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
        <div class="bar4"></div>
        <div class="bar5"></div>
        <div class="bar6"></div>
        <div class="bar7"></div>
        <div class="bar8"></div>
        <div class="bar9"></div>
        <div class="bar10"></div>
        <div class="bar11"></div>
        <div class="bar12"></div>
      </div>

      <div class="player-card card-assigned-player assigned-card">
        <div class="caption">
          <div class="layout-left">
            <span class="season-date"></span>배정 클랜원
          </div>
          <div class="layout-right">
            <div class="button-chip btn-close" onclick="closeAssignedPlayer(this);">닫기</div>
          </div>
        </div>

        <div class="manager-button-area">
          <!--            <div class="button-chip bg-orange">일괄 배정</div>-->
          <!--            <div class="button-chip bg-crimson">일괄 삭제</div>-->
        </div>

        <div class="assigned-player-form assigned-clan">
          <div class="search">
            <div class="search-box">
              <div class="search-field">
                <input placeholder="플레이어 태그를 입력해주세요" class="input player-search-input" type="text">
                <div class="search-box-icon">
                  <button class="btn-icon-content" onclick="searchPlayer(this); return false;">
                    <i class="search-icon">
                      <svg class="icon-search" aria-hidden="true" viewBox="0 0 24 24"><g><path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path></g></svg>
                    </i>
                  </button>
                </div>
              </div>
            </div>

            <div class="player-search-result"></div>
          </div>
        </div>

        <div class="body display-none">

          <div class="support-area">
            <div class="info">
              <span class="regular-text">배정 인원 : <span class="total-size"></span> 명</span>
              <span class="regular-text">이동 인원 : <span class="joined-size"></span> 명</span>
              <span class="regular-text">전쟁 선호 : <span class="war-preference-size"></span> 명 <span class="small-text">(이동 계정 기준)</span></span>
            </div>
            <div class="button-area player-filter-wrapper">
              <div class="radio-inputs player-filter">
                <label class="radio">
                  <input type="radio" name="assigned-filter-{CLAN_TAG}" onclick="filterNotJoined(this, 'all');" class="btn-filter-all" checked>
                  <span class="name">전체</span>
                </label>
                <label class="radio">
                  <input type="radio" name="assigned-filter-{CLAN_TAG}" onclick="filterNotJoined(this, 'not-joined');" class="btn-filter-not-joined">
                  <span class="name">이동 필요</span>
                </label>
              </div>
            </div>
          </div>

          <div class="player-list"></div>

        </div>
      </div>
    </div>

    <div class="player-wrapper card-league-assigned-player-wrapper display-none">
      <div class="loader-circle">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
        <div class="bar4"></div>
        <div class="bar5"></div>
        <div class="bar6"></div>
        <div class="bar7"></div>
        <div class="bar8"></div>
        <div class="bar9"></div>
        <div class="bar10"></div>
        <div class="bar11"></div>
        <div class="bar12"></div>
      </div>

      <div class="player-card card-league-assigned-player assigned-card">
        <div class="caption">
          <div class="layout-left">
            <span class="season-date"></span>리그배정 클랜원
          </div>
          <div class="layout-right">
            <div class="button-chip btn-close" onclick="closeLeagueAssignedPlayer(this);">닫기</div>
          </div>
        </div>

        <div class="manager-button-area">
          <!--            <div class="button-chip bg-orange">일괄 배정</div>-->
          <!--            <div class="button-chip bg-crimson">일괄 삭제</div>-->
        </div>

        <div class="assigned-player-form assigned-league">
          <div class="search">
            <div class="search-box">
              <div class="search-field">
                <input placeholder="플레이어 태그를 입력해주세요" class="input player-search-input" type="text">
                <div class="search-box-icon">
                  <button class="btn-icon-content" onclick="searchPlayer(this); return false;">
                    <i class="search-icon">
                      <svg class="icon-search" aria-hidden="true" viewBox="0 0 24 24"><g><path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path></g></svg>
                    </i>
                  </button>
                </div>
              </div>
            </div>

            <div class="player-search-result"></div>
          </div>
        </div>

        <div class="body display-none">

          <div class="support-area">
            <div class="info">
              <span class="regular-text">배정 인원 : <span class="total-size"></span> 명</span>
              <span class="regular-text">이동 인원 : <span class="joined-size"></span> 명</span>
            </div>
            <div class="button-area player-filter-wrapper">

              <div class="radio-inputs player-filter">
                <label class="radio">
                  <input type="radio" name="league-assigned-filter-{CLAN_TAG}" onclick="filterNotJoined(this, 'all');" class="btn-filter-all" checked>
                  <span class="name">전체</span>
                </label>
                <label class="radio">
                  <input type="radio" name="league-assigned-filter-{CLAN_TAG}" onclick="filterNotJoined(this, 'not-joined');" class="btn-filter-not-joined">
                  <span class="name">이동 필요</span>
                </label>
              </div>

            </div>
          </div>

          <div class="player-list"></div>

        </div>
      </div>
    </div>

  </div>
</template>
<template id="clan-card-not-found">
  <div class="card empty">
    <div class="card-info">
      <div class="text-title">
        <span>클랜 정보 없음</span>
      </div>
    </div>
  </div>
</template>
<template id="player-not-found">
  <div class="player card empty">
    <div class="text-title">
      <span>사용자 정보 없음</span>
    </div>
  </div>
</template>
<template id="button-player-assigned">
  <div class="player-info-item">
    <div class="button-chip bg-green" onclick="assignedMember(this); return false;">배정</div>
  </div>
</template>
<template id="clan-card-register-button">
  <div class="card-button color-green btn-add" onclick="addClan(this); return false;">
    <i class="fa-regular fa-square-plus"></i>
  </div>
</template>
<template id="clan-label-template">
  <div class="chip clan-label">
    <img class="icon label-icon">
  </div>
</template>
<template id="clan-player-info-template">
  <div class="player-info">
    <div class="layout-left">
      <div class="player-info-item">
        <div class="town-hall th{TOWNHALL_LEVEL}"></div>
      </div>
      <div class="player-info-item">
        <div class="info basic">
          <div class="chip bg-crimson small-text tag-hero-level">{HERO_TOTAL_LEVEL}</div>
          <div class="big-text name">{NAME}</div>
          <i class="fa-regular fa-square-minus color-red btn-remove-member cursor-pointer" onclick="removeAssignedMember(this); return false;"></i>
        </div>
        <div class="info additional"></div>
      </div>
    </div>
    <div class="layout-right">
      <div class="player-info-item current-clan">
        <div class="regular-text">{CURRENT_CLAN}</div>
      </div>
      <div class="player-info-item joined">
        <div class="regular-text">{JOINED}</div>
      </div>
    </div>
  </div>
</template>
<template id="player-info-additional-template">
  <div class="chip regular-text">{NAME}</div>
</template>
<template id="icon-arrow-up">
  <i class="fa-solid fa-sort-up"></i>
</template>
<template id="icon-arrow-down">
  <i class="fa-solid fa-sort-down"></i>
</template>
<template id="icon-trophies">
  <div class="icon trophies"></div>
</template>
</html>